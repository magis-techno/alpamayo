# 两种方案对比分析

> 本文档对比 `scenario_framework`（完整规格方案）和 `scenario_framework_lite`（挑战者方案）

---

## 1. 文件结构对比

### 完整规格方案 (`scenario_framework/`)

```
scenario_framework/
├── README.md
├── taxonomy.yaml              # 772 行，L1-L2-L3 分类
├── keyframe_rules.yaml        # 883 行，详细 Keyframe 规则
├── critical_components.yaml   # 951 行，CC 模板
├── driving_decisions.yaml     # 431 行，Decision 定义
├── docs/
│   ├── 01_design_overview.md  # 405 行
│   ├── 02_labeling_spec.md    # 740 行
│   └── appendix_full_taxonomy.md
├── schema/
│   ├── coc_output_schema.json
│   └── labeling_spec_schema.json
└── examples/
    └── ...

总计：约 4000+ 行配置/文档
```

### 挑战者方案 (`scenario_framework_lite/`)

```
scenario_framework_lite/
├── README.md
├── l1_principles.yaml         # ~250 行，L1 级原则
├── driving_decisions.yaml     # ~200 行，Decision 定义（与完整方案相同）
├── output_schema.json         # ~150 行，输出格式
├── prompts/
│   └── coc_generation.md      # ~200 行，LLM Prompt
└── examples/
    └── ...

总计：约 800 行配置/文档
```

**精简比例：约 80%**

---

## 2. 核心组件对比

| 组件 | 完整方案 | 挑战者方案 | 差异 |
|------|---------|-----------|------|
| **L1 分类** | 5 类 | 5 类 | ✅ 相同 |
| **L2 分类** | 30 类 | ❌ 无 | LLM 自由描述 |
| **L3 分类** | 95 类 | ❌ 无 | LLM 自由描述 |
| **Keyframe 规则** | 30 条 L2 规则 | 5 条 L1 原则 | LLM 根据原则推断 |
| **CC 模板** | 30 套详细模板 | 5 套通用指南 | LLM 自由生成 |
| **Decision 闭集** | 9+9 种 | 9+9 种 | ✅ 相同（必须保留） |
| **输出 Schema** | 详细结构化 | 简化版 | 兼容 |

---

## 3. Keyframe 定义对比

### 完整方案：每个 L2 有具体规则

```yaml
# keyframe_rules.yaml (示例)

cutin_urgent:
  keyframe_type: reactive
  definition: "他车任一车轮越过车道线进入 ego 车道的时刻"
  start_time: "keyframe - 2s"
  end_time: "他车回正 + 3s"
  
vru_crossing:
  keyframe_type: reactive
  definition: "VRU 进入 ego 未来轨迹横向 7m 范围的时刻"
  start_time: "VRU 进入 ROI"
  end_time: "VRU 驶离后验通道 + 3s"
  
vru_emergence:
  keyframe_type: reactive
  definition: "VRU 首次进入 ego 视野的时刻"
  start_time: "keyframe"
  end_time: "keyframe + 3s"
```

### 挑战者方案：L1 级抽象原则

```yaml
# l1_principles.yaml (示例)

reactive_agent:
  general_principle: |
    Keyframe = 外部交通参与者的动作触发 ego 必须响应的时刻。
    选择"外部事件发生"的时刻，而非"ego 开始响应"的时刻。
    
  typical_scenarios:  # 仅作为 hint，不是硬性规则
    - scenario: "车辆切入"
      keyframe_hint: "他车车轮越过车道线"
    - scenario: "VRU 横穿"
      keyframe_hint: "VRU 进入 ego 轨迹范围"
```

### 关键区别

| 方面 | 完整方案 | 挑战者方案 |
|------|---------|-----------|
| 规则数量 | 30 条 | 5 条 |
| 规则形式 | 具体规则 | 抽象原则 + hint |
| 新场景处理 | 需要新增规则 | LLM 根据原则推断 |
| 一致性保证 | 规则强制 | 依赖 LLM |
| 灵活性 | 低 | 高 |

---

## 4. 适用场景对比

| 场景 | 完整方案 | 挑战者方案 | 推荐 |
|------|---------|-----------|------|
| 快速原型（<500 条） | ⚠️ 过度设计 | ✅ 推荐 | 挑战者 |
| 中等规模（500-5000 条） | ✅ 推荐 | ⚠️ 需验证 | 视情况 |
| 大规模生产（>5000 条） | ✅ 推荐 | ❌ 风险高 | 完整方案 |
| 探索性研究 | ⚠️ 可能限制 | ✅ 推荐 | 挑战者 |
| 长期迭代维护 | ✅ 推荐 | ⚠️ 追溯性差 | 完整方案 |
| 新场景频繁出现 | ⚠️ 维护成本高 | ✅ 适应性好 | 挑战者 |

---

## 5. 风险对比

### 完整方案的风险

| 风险 | 严重程度 | 说明 |
|------|---------|------|
| 过度设计 | 🟡 中 | 95 个 L3 可能很多用不到 |
| 前期成本高 | 🟡 中 | 需要数周设计规格 |
| 维护成本 | 🟡 中 | 新场景需要更新规格 |
| 设计者偏见 | 🟢 低 | 规格反映设计者认知 |

### 挑战者方案的风险

| 风险 | 严重程度 | 说明 |
|------|---------|------|
| Keyframe 不一致 | 🔴 高 | LLM 解读可能不稳定 |
| 因果混淆 | 🔴 高 | LLM 可能用后见之明 |
| 输出不稳定 | 🟡 中 | 同一输入，不同输出 |
| 难以追溯 | 🟡 中 | 出问题难以定位 |
| 质量评估难 | 🟡 中 | 没有标准判断质量 |

---

## 6. 验证建议

### 使用挑战者方案前，建议验证

```
1. 准备 50 个测试用例（覆盖各 L1 场景）

2. 对每个用例运行 3 次 LLM 生成

3. 检查指标：
   - Keyframe 一致性：同一用例，3 次运行偏差 < 0.5s
   - Decision 一致性：同类场景，Decision 选择一致
   - CoC 质量：人工审核合格率

4. 验收标准：
   - Keyframe 一致性 > 90%
   - Decision 一致性 > 95%
   - CoC 质量合格率 > 85%

5. 如果不达标：
   - 方案 A：改进 L1 原则，增加更具体的 hint
   - 方案 B：引入关键场景的 L2 规则（混合方案）
```

---

## 7. 推荐的演进路径

```
阶段 1: 使用挑战者方案验证
├── 100 条数据快速验证
├── 评估 LLM 一致性
└── 确定是否可行

阶段 2: 根据结果决策
├── 如果一致性足够 → 继续使用挑战者方案
├── 如果一致性不足 → 引入关键 L2 规则（混合方案）
└── 如果质量要求高 → 切换到完整方案

阶段 3: 大规模应用
├── 根据数据规模选择方案
├── 建立质量监控
└── 持续迭代优化
```

---

## 8. CoC Trace 风格：自然语言 vs 填空式

### 调研结论

通过调研 Alpamayo-R1 论文和主流 VLA 实践，我们发现：

| 方案 | 特点 | 优点 | 缺点 |
|------|------|------|------|
| **填空式模板** | `TTC={ttc}s, 速度={speed}kph` | 机器可解析，统计方便 | 机械，表达受限 |
| **纯自由形式** | 完全自然语言 | 灵活，丰富 | 一致性差，难以自动评估 |
| **混合形式** ✅ | 结构化组件 + 自然语言 Trace | 兼顾一致性和表达力 | 需要定义好边界 |

### Alpamayo-R1 的实际做法

论文中 CoC 数据由三部分组成：

1. **Driving Decision**（闭集） - 必须从预定义列表选择
2. **Critical Components**（开集） - 自由列出因果因素
3. **CoC Trace**（自然语言） - 但受约束：
   - 必须提及决策
   - 必须提及关键因素
   - 必须有因果连接
   - 禁止提及未来不可观测信息

### 推荐风格

**不推荐**（填空式）：
```
左侧小型车正在切入自车车道，TTC 约 2.5s。
切入车辆速度约 65kph，与自车速度差约 15kph，未打转向灯。
决策：纵向减速让行（yield_to_agent），横向保持当前车道（lane_keeping）。
```

**推荐**（自然语言）：
```
左侧有车辆未打灯切入我的车道，切入时间较短。
需要减速以保持安全跟车距离。
决策：让行减速，保持车道。
```

### 关键差异

| 方面 | 填空式 | 自然语言 |
|------|--------|---------|
| 数值 | 精确 (TTC=2.5s, 65kph) | 定性 (切入时间较短) |
| 决策表述 | `yield_to_agent` 括号标注 | 简洁中文 (让行减速) |
| 长度 | 较长，信息密集 | 简洁，因果清晰 |
| 可读性 | 像表格 | 像自然叙述 |

---

## 9. 混合方案建议

如果挑战者方案一致性不够，但完整方案又太重，可以考虑混合方案：

```yaml
# 混合方案：L1 原则 + 关键 L2 规则

l1_principles:
  reactive_agent:
    general_principle: "..." 
    # 保持 L1 原则

key_l2_rules:  # 只定义关键场景的具体规则
  cutin:
    keyframe: "他车车轮越过车道线"
    reason: "cutin 场景频繁，歧义大"
    
  vru_emergence:
    keyframe: "VRU 首次进入视野"
    reason: "鬼探头场景安全敏感"
    
  # 其他场景使用 L1 原则 + LLM 推断

规则数量: 10-15 条（只覆盖关键场景）
```

---

## 9. 结论

| 方案 | 适用场景 | 核心权衡 |
|------|---------|---------|
| **完整方案** | 大规模生产、长期迭代 | 前期成本高，但质量可控 |
| **挑战者方案** | 快速验证、小规模、探索性 | 启动快，但一致性风险 |
| **混合方案** | 中等规模、平衡需求 | 关键场景有规则，其他靠 LLM |

**最终建议**：

> 先用挑战者方案跑 100 条数据验证一致性。
> 
> 如果一致性足够（>90%），继续使用。
> 
> 如果不足，针对问题最多的场景引入 L2 规则，形成混合方案。
> 
> 不必一开始就上完整方案，但也不能完全不管一致性。
